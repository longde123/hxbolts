<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>hxbolts by restorer</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/github-light.css">
    <meta name="viewport" content="width=device-width">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>hxbolts</h1>
        <p>Deal with async tasks like a boss</p>

        <p class="view"><a href="https://github.com/restorer/hxbolts">View the Project on GitHub <small>restorer/hxbolts</small></a></p>


        <ul>
          <li><a href="https://github.com/restorer/hxbolts/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/restorer/hxbolts/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/restorer/hxbolts">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <p><img src="http://restorer.github.io/hxbolts/images/hxbolts-logo.png" alt="Logo"></p>

<p>hxbolts is a port of a "tasks" component from java library named Bolts.
A task is kind of like a JavaScript Promise, but with different API.</p>

<p>While original java library is about keeping long-running operations out of the UI thread,
current version of hxbolts is more about transforming async callback hell into nice looking code.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installation</h2>

<pre><code>haxelib install hxbolts
</code></pre>

<h2>
<a id="lets-talk" class="anchor" href="#lets-talk" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Let's talk</h2>

<p>Imagine you have to delete all comments from blog while player playing in your game, mwahahaha <g-emoji alias="smiling_imp" fallback-src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f608.png">ðŸ˜ˆ</g-emoji> . But server API has only 4 methods:</p>

<ol>
<li>Authorize;</li>
<li>Get all posts ids;</li>
<li>Get all comments ids for specific post;</li>
<li>Delete specific comment by id.</li>
</ol>

<p>Let you have a function for making async requests:</p>

<div class="highlight highlight-source-haxe-2"><pre><span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">function</span> <span class="pl-en">makeRequestAsync</span>(
    url : <span class="pl-c1">String</span>,
    callback : <span class="pl-c1">String</span> <span class="pl-k">-</span><span class="pl-k">&gt;</span> <span class="pl-c1">Void</span>
) : <span class="pl-c1">Void</span> { <span class="pl-k">...</span> }</pre></div>

<p>Usually code will look like:</p>

<div class="highlight highlight-source-haxe-2"><pre><span class="pl-k">var</span> <span class="pl-en">token</span> : <span class="pl-c1">String</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>;

makeRequestAsync(<span class="pl-s"><span class="pl-pds">"</span>http://blog.tld/api/authorize?user=me<span class="pl-pds">"</span></span>, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
    <span class="pl-k">try</span> {
        token <span class="pl-k">=</span> <span class="pl-c1">Reflect.</span>field(<span class="pl-c1">Json.</span>parse(result), <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>);
    } <span class="pl-k">catch</span> (e : <span class="pl-c1">Dynamic</span>) {
        <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Error occurred : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">Std.</span>string(e));
        <span class="pl-k">return</span>;
    }

    makeRequestAsync(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/postsIds?token=<span class="pl-smi">${token}</span><span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
        <span class="pl-k">var</span> ids : <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Int</span><span class="pl-k">&gt;</span>;

        <span class="pl-k">try</span> {
            ids <span class="pl-k">=</span> <span class="pl-k">cast</span> <span class="pl-c1">Json.</span>parse(result);
        } <span class="pl-k">catch</span> (e : <span class="pl-c1">Dynamic</span>) {
            <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Error occurred : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">Std.</span>string(e));
            <span class="pl-k">return</span>;
        }

        <span class="pl-k">var</span> results <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>();

        <span class="pl-k">for</span> (id in ids) {
            makeRequestAsync(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/commentsIds?token=<span class="pl-smi">${token}</span>&amp;postId=<span class="pl-smi">${id}</span><span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
                results.push(result);

                <span class="pl-k">if</span> (results.length <span class="pl-k">==</span> ids.length) {
                    <span class="pl-c">// ...</span>
                }
            });
        }
    });
});</pre></div>

<p>Uh oh... And I donâ€™t even started deletion process.</p>

<h2>
<a id="hxbolts-coming-to-the-rescue" class="anchor" href="#hxbolts-coming-to-the-rescue" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>hxbolts coming to the rescue!</h2>

<p>At first we need to <em>boltify</em> makeRequestAsync function:</p>

<div class="highlight highlight-source-haxe-2"><pre><span class="pl-k">private</span> <span class="pl-k">static</span> <span class="pl-k">function</span> <span class="pl-en">makeRequestTask</span>(url : <span class="pl-c1">String</span>) : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span> {
    <span class="pl-k">var</span> tcs <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">TaskCompletionSource</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>();

    makeRequestAsync(url, <span class="pl-k">function</span>(result : <span class="pl-c1">String</span>) : <span class="pl-c1">Void</span> {
        tcs.setResult(result);
    });

    <span class="pl-k">return</span> tcs.task;
}</pre></div>

<p>The rest is easy:</p>

<div class="highlight highlight-source-haxe-2"><pre><span class="pl-k">var</span> <span class="pl-en">token</span> : <span class="pl-c1">String</span> <span class="pl-k">=</span> <span class="pl-c1">null</span>;

makeRequestTask(<span class="pl-s"><span class="pl-pds">"</span>http://blog.tld/api/authorize?user=me<span class="pl-pds">"</span></span>).onSuccessTask(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>) : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span> {
    token <span class="pl-k">=</span> <span class="pl-c1">Reflect.</span>field(<span class="pl-c1">Json.</span>parse(task.result), <span class="pl-s"><span class="pl-pds">"</span>token<span class="pl-pds">"</span></span>);
    <span class="pl-k">return</span> makeRequestTask(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/postsIds?token=<span class="pl-smi">${token}</span><span class="pl-pds">'</span></span>);
}).onSuccessTask(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;</span>) : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span> {
    <span class="pl-k">var</span> tasks <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span>();

    <span class="pl-k">for</span> (id in (<span class="pl-k">cast</span> <span class="pl-c1">Json.</span>parse(task.result) : <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Int</span><span class="pl-k">&gt;</span>)) {
        tasks.push(makeRequestTask(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/commentsIds?token=<span class="pl-smi">${token}</span>&amp;postId=<span class="pl-smi">${id}</span><span class="pl-pds">'</span></span>));
    }

    <span class="pl-k">return</span> <span class="pl-c1">Task.</span>whenAllResult(tasks);
}).onSuccessTask(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span>) : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Void</span><span class="pl-k">&gt;</span> {
    <span class="pl-k">var</span> tasks <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">String</span><span class="pl-k">&gt;&gt;</span>();

    <span class="pl-k">for</span> (response in task.result) {
        <span class="pl-k">for</span> (id in (<span class="pl-k">cast</span> <span class="pl-c1">Json.</span>parse(response) : <span class="pl-c1">Array</span><span class="pl-k">&lt;</span><span class="pl-c1">Int</span><span class="pl-k">&gt;</span>)) {
            tasks.push(makeRequestTask(<span class="pl-s"><span class="pl-pds">'</span>http://blog.tld/api/deleteComment?token=<span class="pl-smi">${token}</span>&amp;commentId=<span class="pl-smi">${id}</span><span class="pl-pds">'</span></span>));
        }
    }

    <span class="pl-k">return</span> <span class="pl-c1">Task.</span>whenAll(tasks);
}).continueWith(<span class="pl-k">function</span>(task : <span class="pl-c1">Task</span><span class="pl-k">&lt;</span><span class="pl-c1">Void</span><span class="pl-k">&gt;</span>) : <span class="pl-c1">Void</span> {
    <span class="pl-k">if</span> (task.isSuccessed) {
        <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Everything is good<span class="pl-pds">"</span></span>);
    } <span class="pl-k">else</span> {
        <span class="pl-k">trace</span>(<span class="pl-s"><span class="pl-pds">"</span>Error occurred : <span class="pl-pds">"</span></span> <span class="pl-k">+</span> <span class="pl-c1">Std.</span>string(task.error));
    }
});</pre></div>

<p>Code is linear, easy to understand. It even doesnâ€™t contains try / catch blocks, because hxbolts will take care about exceptions.</p>

<p>Check out more examples at <a href="https://github.com/restorer/hxbolts">hxbolts repo</a>.</p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/restorer">restorer</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
    
  </body>
</html>
